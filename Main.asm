; =========================================================================================================================================================
; Hedgebrew Engine (Clean, Overhauled, Enhanced S3&K Engine)
; =========================================================================================================================================================
; ---------------------------------------------------------------------------------------------------------------------------------------------------------
; Configuration
; ---------------------------------------------------------------------------------------------------------------------------------------------------------
		include	"Config/Configuration.asm"	; Configuration

		include	"Sound/langZ80.asm"		; Z80 Language macros
		include	"Sound/amps/code/macro.asm"	; AMPS macros
		include	"Sound/amps/code/smps2asm.asm"	; AMPS SMPS2ASM

		include	"Config/Constants.asm"		; Constants
		include	"Config/Macros.asm"		; Macros
		include	"Config/Offsets.asm"		; Offsets
		include	"Config/Variables.asm"		; Variables

		include	"Config/Error/debugger.asm"	; Debugger macro set
		
; ---------------------------------------------------------------------------------------------------------------------------------------------------------
; Header
; ---------------------------------------------------------------------------------------------------------------------------------------------------------
		include	"Config/Header.asm"

; ---------------------------------------------------------------------------------------------------------------------------------------------------------
; Entry point
; ---------------------------------------------------------------------------------------------------------------------------------------------------------
GameInit:
		intsOff						; Disable interrupts
		
		clrRAM	RAM_START, RAM_END			; Clear RAM
		
		bsr.w	InitDMAQueue				; Initialize the DMA queue
		bsr.w	InitVDP					; Initialize the VDP
		jsr	LoadDualPCM				; Load Dual PCM
		
		move.b	HW_VERSION,d0				; Get hardware version
		andi.b	#$C0,d0					; Just get region bits
		move.b	d0,rHWVersion.w				; Store in RAM

		move.w	#$4EF9,d0				; JMP opcode
		move.w	d0,rVIntJmp.w				; Set the "JMP" command for V-INT
		move.w	d0,rHIntJmp.w				; Set the "JMP" command for H-INT
		move.l	#VInt_Standard,rVIntAddr.w		; Set the V-INT pointer to the standard V-INT routine
		move.l	#HInt_Water,rHIntAddr.w			; Set the H-INT pointer to the standard V-INT routine

		clr.w	rDMAQueue.w				; Set stop token at the beginning of the DMA queue
		move.w	#rDMAQueue,rDMASlot.w			; Reset the DMA queue slot

		move.b	#gLevel,rGameMode.w			; Set game mode to "title"
		jmp	Level					; Go to the title screen

; =========================================================================================================================================================
; ---------------------------------------------------------------------------------------------------------------------------------------------------------
; Go to the correct game mode
; ---------------------------------------------------------------------------------------------------------------------------------------------------------
GotoGameMode:
		moveq	#0,d0
		move.b	rGameMode.w,d0				; Get game mode ID
		movea.l	.GameModes(pc,d0.w),a0			; Get pointer
		jmp	(a0)					; Jump to it
; ---------------------------------------------------------------------------------------------------------------------------------------------------------
.GameModes:
		dc.l	TitleScreen				; Title screen
		dc.l	Level					; Level mode
		dc.l	Ending					; Ending

; =========================================================================================================================================================
; ---------------------------------------------------------------------------------------------------------------------------------------------------------
; Function libraries
; ---------------------------------------------------------------------------------------------------------------------------------------------------------
		include	"Libraries/VDP.asm"		; VDP functions
		include	"Libraries/Joypad.asm"		; Joypad functions
		include	"Libraries/Decompression.asm"	; Decompression functions
		include	"Libraries/Math.asm"		; Math functions
		include	"Libraries/Object.asm"		; Object functions
		include	"Libraries/Interrupt.asm"	; Interrupt functions

; =========================================================================================================================================================
; ---------------------------------------------------------------------------------------------------------------------------------------------------------
; Opmode Main Code
; ---------------------------------------------------------------------------------------------------------------------------------------------------------
		include	"Opmodes/Title/Main.asm"
		include	"Opmodes/Gameplay/Main.asm"
		include	"Opmodes/Ending/Main.asm"

; =========================================================================================================================================================
; ---------------------------------------------------------------------------------------------------------------------------------------------------------
; Sound driver
; ---------------------------------------------------------------------------------------------------------------------------------------------------------
		include	"Sound/amps/code/68k.asm"
DualPCM:
		z80prog	0
		include	"Sound/amps/code/Z80.asm"
DualPCM_sz:
		z80prog

; =========================================================================================================================================================
; ---------------------------------------------------------------------------------------------------------------------------------------------------------
; Error handler
; -------------------------------------------------------------------------------------------------------------------------------------------------------
		include	"Config/Error/error.asm"
; =========================================================================================================================================================